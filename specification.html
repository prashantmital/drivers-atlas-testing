
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>Technical Design: Testing Drivers Against Atlas Planned Maintenance &#8212; astrolabe  documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Integration Guide" href="integration-guide.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="technical-design-testing-drivers-against-atlas-planned-maintenance">
<h1><a class="toc-backref" href="#id19">Technical Design: Testing Drivers Against Atlas Planned Maintenance</a><a class="headerlink" href="#technical-design-testing-drivers-against-atlas-planned-maintenance" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Title</dt>
<dd class="field-odd"><p>Testing Drivers against Atlas Planned Maintenance</p>
</dd>
<dt class="field-even">Author</dt>
<dd class="field-even"><p>Prashant Mital</p>
</dd>
<dt class="field-odd">Lead</dt>
<dd class="field-odd"><p>Matt Broadstone</p>
</dd>
<dt class="field-even">Advisors</dt>
<dd class="field-even"><p>Andrew Davidson, Sheeri Cabral, Will Shulman, Jeremy Mikola, Ian Whalen, Rachelle Palmer</p>
</dd>
<dt class="field-odd">Status</dt>
<dd class="field-odd"><p>Approved</p>
</dd>
<dt class="field-even">Type</dt>
<dd class="field-even"><p>Process</p>
</dd>
<dt class="field-odd">Minimum Server Version</dt>
<dd class="field-odd"><p>N/A</p>
</dd>
<dt class="field-even">Last Modified</dt>
<dd class="field-even"><p>January 28, 2020</p>
</dd>
</dl>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#technical-design-testing-drivers-against-atlas-planned-maintenance" id="id19">Technical Design: Testing Drivers Against Atlas Planned Maintenance</a></p>
<ul>
<li><p><a class="reference internal" href="#abstract" id="id20">Abstract</a></p></li>
<li><p><a class="reference internal" href="#definitions" id="id21">Definitions</a></p>
<ul>
<li><p><a class="reference internal" href="#meta" id="id22">META</a></p></li>
<li><p><a class="reference internal" href="#terms" id="id23">Terms</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#architecture-overview" id="id24">Architecture Overview</a></p></li>
<li><p><a class="reference internal" href="#test-scenario-format" id="id25">Test Scenario Format</a></p></li>
<li><p><a class="reference internal" href="#workload-executor" id="id26">Workload Executor</a></p>
<ul>
<li><p><a class="reference internal" href="#user-facing-api" id="id27">User-Facing API</a></p></li>
<li><p><a class="reference internal" href="#pseudocode-implementation" id="id28">Pseudocode Implementation</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#test-orchestrator" id="id29">Test Orchestrator</a></p>
<ul>
<li><p><a class="reference internal" href="#features" id="id30">Features</a></p></li>
<li><p><a class="reference internal" href="#id16" id="id31">User-Facing API</a></p></li>
<li><p><a class="reference internal" href="#id17" id="id32">Pseudocode Implementation</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#reference-implementation" id="id33">Reference Implementation</a></p></li>
</ul>
</li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="abstract">
<h2><a class="toc-backref" href="#id20">Abstract</a><a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h2>
<p>Testing drivers against Atlas clusters undergoing maintenance is required to increase the likelihood that deviations
of driver behavior from the high-availability and/or graceful-failure characteristics promised by <a class="reference external" href="https://github.com/mongodb/specifications">driver
specifications</a> are detected and rectified during development.
This specification outlines a testing framework that streamlines the process of testing drivers against Atlas clusters
undergoing maintenance thereby ensuring expeditious incorporation of this additional testing into all driver projects.
The improved test coverage will result in a superior user experience as workload disruption during planned maintenance
due to undiscovered bugs in the drivers, server or Atlas will become less likely.</p>
</div>
<div class="section" id="definitions">
<h2><a class="toc-backref" href="#id21">Definitions</a><a class="headerlink" href="#definitions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="meta">
<h3><a class="toc-backref" href="#id22">META</a><a class="headerlink" href="#meta" title="Permalink to this headline">¶</a></h3>
<p>The keywords “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and
“OPTIONAL” in this document are to be interpreted as described in <a class="reference external" href="https://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>.</p>
</div>
<div class="section" id="terms">
<h3><a class="toc-backref" href="#id23">Terms</a><a class="headerlink" href="#terms" title="Permalink to this headline">¶</a></h3>
<dl class="simple">
<dt>Atlas Cluster</dt><dd><p>Subordinate of an <em>Atlas Project</em> in Atlas’ Organizations and Projects hierarchy <a class="footnote-reference brackets" href="#f1" id="id1">1</a>, an Atlas Cluster is a set of
nodes comprising a MongoDB deployment.</p>
</dd>
<dt>Atlas Project</dt><dd><p>Subordinate of an <em>Atlas Organization</em> in Atlas’ Organizations and Projects hierarchy <a class="footnote-reference brackets" href="#f1" id="id2">1</a>. Each Atlas Organization
can contain multiple Atlas Projects.</p>
</dd>
<dt>Atlas Organization</dt><dd><p>The top-level entity in Atlas’ Organizations and Projects hierarchy <a class="footnote-reference brackets" href="#f1" id="id3">1</a>.</p>
</dd>
<dt>Atlas Planned Maintenance Test</dt><dd><p>An integration test that involves running a <em>Driver Workload</em> using a MongoDB Driver against an <em>Atlas Cluster</em> that
is in the midst of applying a <em>Planned Maintenance Scenario</em>.</p>
</dd>
<dt>Cluster Configuration Options</dt><dd><p>Umbrella term used to refer to all parameters that can be used to configure an <em>Atlas Cluster</em> via the <em>Atlas API</em>.
There are two kinds of cluster configuration options - <em>Basic Configuration Options</em> and <em>Advanced Configuration Options</em>.</p>
</dd>
<dt>Basic Configuration Options</dt><dd><p>Set of cluster configuration parameters that can be used to create a new <em>Atlas Cluster</em> via the Create One Cluster <a class="footnote-reference brackets" href="#f2" id="id4">2</a> endpoint,
or that can be applied to an existing cluster via the Modify One Cluster <a class="footnote-reference brackets" href="#f3" id="id5">3</a> endpoint.</p>
</dd>
<dt>Advanced Configuration Options</dt><dd><p>Set of cluster configuration parameters that be applied to an existing <em>Atlas Cluster</em> via the
Modify Advanced Configuration Options for One Cluster <a class="footnote-reference brackets" href="#f4" id="id6">4</a> endpoint.</p>
</dd>
<dt>Cluster State</dt><dd><p>The state of an <em>Atlas Cluster</em> as advertised by the “stateName” field in the response of the
Get One Cluster <a class="footnote-reference brackets" href="#f5" id="id7">5</a> endpoint.</p>
</dd>
<dt>Test Scenario File</dt><dd><p>A file containing a language and driver-agnostic description of a single <em>Atlas Planned Maintenance Test</em>.
Each file specifies a <em>Planned Maintenance Scenario</em> and the associated <em>Driver Workload</em>.</p>
</dd>
<dt>Planned Maintenance Scenario</dt><dd><p>Description of a plan to modify the <em>Cluster Configuration Options</em> of a running <em>Atlas Cluster</em>.
A maintenance plan is described fully by an associated set of initial and final <em>Cluster Configuration Options</em>.</p>
</dd>
<dt>Driver Workload</dt><dd><p>A language-agnostic description of MongoDB driver operations.</p>
</dd>
<dt>Workload Executor</dt><dd><p>A user-implemented, driver-specific script responsible for parsing a <em>Driver Workload</em> and translating it into
actual driver operations that are run against the test cluster.</p>
</dd>
<dt>Test Orchestrator</dt><dd><p>User-facing command-line utility that accepts a <em>Workload Executor</em> and a <em>Test Scenario File</em> and runs an <em>Atlas Planned Maintenance Test</em>.</p>
</dd>
<dt>Atlas API</dt><dd><p><a class="reference external" href="https://docs.atlas.mongodb.com/api/">REST API</a> that provides programmatic access to MongoDB Atlas.</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="architecture-overview">
<h2><a class="toc-backref" href="#id24">Architecture Overview</a><a class="headerlink" href="#architecture-overview" title="Permalink to this headline">¶</a></h2>
<p>To ensure maintainability and extensibility, the Atlas Planned Maintenance Testing Framework has a modular design
comprised of the following components:</p>
<ol class="arabic simple">
<li><p>Test Scenario Format: the test format creates a standard language for describing Atlas Planned Maintenance Tests.</p></li>
<li><p>Workload Executor: a user-implemented, driver-specific script with a standard command-line API that translates driver
workloads described in the test scenario format into driver operations that are run against the test cluster.</p></li>
<li><p>Test Orchestrator: a command-line utility that accepts Workload Executor and test specification in the
Test Scenario Format and runs an Atlas Planned Maintenance Test. The Atlas Controller is responsible for
leveraging the Atlas API to provision, configure, and monitor the Atlas cluster.</p></li>
</ol>
<div class="figure align-default" id="id18" style="width: 100%">
<img alt="_images/specification-schematic.png" src="_images/specification-schematic.png" />
<p class="caption"><span class="caption-text">Schematic representation of the test framework architecture.</span><a class="headerlink" href="#id18" title="Permalink to this image">¶</a></p>
</div>
<p>The subsequent sections describe each of these components in greater detail and are intended as a reference for implementation of the testing framework described in this specification. Drivers MUST integrate this testing framework into their continuous integration workflow - see the Integration Guide for instructions.</p>
</div>
<div class="section" id="test-scenario-format">
<h2><a class="toc-backref" href="#id25">Test Scenario Format</a><a class="headerlink" href="#test-scenario-format" title="Permalink to this headline">¶</a></h2>
<p>The test scenario format is used for defining platform-independent <em>Atlas Planned Maintenance Tests</em> in YAML-formatted
<em>Test Scenario Files</em>. Each Test Scenario File describes exactly one Atlas Planned Maintenance Test. A Test Scenario
File has the following keys:</p>
<ul class="simple">
<li><p>maintenancePlan (document): a <em>Planned Maintenance Scenario</em> object. Each object has the following keys:</p>
<ul>
<li><p>initialConfiguration (document): Description of <em>Cluster Configuration Options</em> to be used for initializing the
test cluster. This document MUST contain the following keys:</p>
<ul>
<li><p>clusterConfiguration (document): Document containing initial <em>Basic Configuration Options</em> values.
This document MUST, at a minimum, have all fields <strong>required</strong> by the Create One Cluster <a class="footnote-reference brackets" href="#f2" id="id8">2</a> endpoint.</p></li>
<li><p>processArgs (document): Document containing initial <em>Advanced Configuration Option</em> values. This MAY be an empty
document if the maintenance plan does not require modifying the Advanced Configuration Options.</p></li>
</ul>
</li>
<li><p>finalConfiguration (document): Description of <strong>new</strong> <em>Cluster Configuration Options</em> to be applied to the
test cluster. This document MUST contain the following keys (note that at least one of these fields MUST be
a non-empty document):</p>
<ul>
<li><p>clusterConfiguration (document): Document containing final <em>Basic Configuration Option</em> values.
This MAY be an empty document if no changes to the Basic Configuration Options are needed by the maintenance plan.
If non-empty, this document MUST, at a minimum, have all fields <strong>required</strong> by the Modify One Cluster <a class="footnote-reference brackets" href="#f3" id="id9">3</a> endpoint.</p></li>
<li><p>processArgs (document): Document containing final <em>Advanced Configuration Option</em> values.
This MAY be an empty document if the maintenance plan does not require modifying the Advanced Configuration Options.</p></li>
</ul>
</li>
<li><p>uriOptions (document): Document containing <code class="docutils literal notranslate"><span class="pre">key:</span> <span class="pre">value</span></code> pairs of URI options that must be included in the
connection string passed to the workload executor by the <em>Test Orchestrator</em>.</p></li>
</ul>
</li>
<li><p>driverWorkload (document): Object describing a <em>Driver Workload</em>. Has the following keys:</p>
<ul>
<li><p>collection (string): Name of the collection to use for running test operations.</p></li>
<li><p>database (string): Name of the database to use for running test operations.</p></li>
<li><p>testData (array, optional): Array of documents to be inserted into the <code class="docutils literal notranslate"><span class="pre">database.collection</span></code> namespace before
starting the test run. Test data insertion is performed by the <em>Test Orchestrator</em> and this field MUST be ignored
by the <em>Workload Executor</em>.</p></li>
<li><p>operations (array): Array of Operation objects, each describing an operation to be executed. The operations are run
sequentially and repeatedly until the maintenance completes. Each object has the following keys:</p>
<ul>
<li><p>object (string): The entity on which to perform the operation. Can be “database” or “collection”.</p></li>
<li><p>name (string): name of the operation.</p></li>
<li><p>arguments (document): the names and values of arguments to be passed to the operation.</p></li>
<li><p>result (optional, multiple types): The result of executing the operation. This will correspond to the operation’s
return value.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="workload-executor">
<span id="workload-executor-specification"></span><h2><a class="toc-backref" href="#id26">Workload Executor</a><a class="headerlink" href="#workload-executor" title="Permalink to this headline">¶</a></h2>
<p>The <em>Workload Executor</em> is a script that must be implemented by each driver to facilitate incorporation of
<em>Atlas Planned Maintenance Tests</em> into the CI workflow of that driver. The script provides a layer of abstraction
between the <em>Test Orchestrator</em> and the code responsible for translating the <em>Driver Workload</em> (specified in the
Test Scenario Format) into actual driver operations.</p>
<div class="section" id="user-facing-api">
<h3><a class="toc-backref" href="#id27">User-Facing API</a><a class="headerlink" href="#user-facing-api" title="Permalink to this headline">¶</a></h3>
<p>The workload executor MUST be an executable that can be invoked as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ path/to/workload-executor connection-string workload-spec
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">path/to/workload-executor</span></code> is the path to the Workload Executor executable script,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">connection-string</span></code> is the connection string (including username, password and authentication database)
that is to be used by the driver connect to the Atlas cluster, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">workload-spec</span></code> is a JSON blob containing the <em>Driver Workload</em> in the Test Scenario Format.</p></li>
</ul>
</div>
<div class="section" id="pseudocode-implementation">
<h3><a class="toc-backref" href="#id28">Pseudocode Implementation</a><a class="headerlink" href="#pseudocode-implementation" title="Permalink to this headline">¶</a></h3>
<p>The pseudocode implementation in this section is provided for illustrative purposes only. The actual implementation
of workload executors is dependent upon the implementation details of the Test Orchestrator and is described in the
Integration Guide.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># targetDriver is the driver to be tested.
import { MongoClient } from &quot;targetDriver&quot;

# The workloadRunner function accepts a connection string and a stringified JSON blob describing the driver workload.
# This function will be invoked with arguments parsed from the command-line invocation of the workload executor script.
function workloadRunner(connectionString: string, workloadSpec: object): void {

    # Use the MongoClient of the driver to be tested to connect to the Atlas Cluster.
    const client = MongoClient(connectionString);

    # Create objects which will be used to run operations.
    const db = client.db(workloadSpec.database_name);
    const collection = db.collection(workloadSpec.collection_name);

    # Initialize error counter.
    var error_count = 0;

    # Run the workload.
    try {
        while (True) {
            for (let operation in workloadSpec.operations) {

                # For this example, in the event of an error, runOperation returns false.
                # Tracebacks are caught and logged to STDOUT as is any non-error related output from the driver.
                if (!runOperation(db, collection, operation)) {

                    # Keep track of the number of errors.
                    error_count += 1;
                }
            }
        }
    # The workloadExecutor MUST handle SIGINT gracefully.
    # SIGINT will be used by the Test Orchestrator to terminate operations running ad infinitum.
    } catch (SIGINT) {
        # The workload statistics must be logged to STDERR.
        process.error(JSON.stringify({‘numErrors’: error_count}));

        # The workload executor MUST set a non-zero exit-code if there was a failure.
        if (error_count) { process.exit(1); }
        else { process.exit(0); }
    }
}
</pre></div>
</div>
</div>
</div>
<div class="section" id="test-orchestrator">
<h2><a class="toc-backref" href="#id29">Test Orchestrator</a><a class="headerlink" href="#test-orchestrator" title="Permalink to this headline">¶</a></h2>
<p>The Test Orchestrator is a command-line utility that ingests a Atlas Planned Maintenance Test specified in the
Test Scenario Format and leverages the Atlas API and a user-supplied Workload Executor to run the test on a live
Atlas Cluster.</p>
<div class="section" id="features">
<h3><a class="toc-backref" href="#id30">Features</a><a class="headerlink" href="#features" title="Permalink to this headline">¶</a></h3>
<p>The Test Orchestrator MUST support the following, low-level operations via the MongoDB Atlas API:</p>
<ol class="arabic simple">
<li><p>Creating a new Atlas Cluster with the given Cluster Configuration Options <a class="footnote-reference brackets" href="#f2" id="id10">2</a>.</p></li>
<li><p>Adding a given IP address to the IP whitelist of an Atlas Project <a class="footnote-reference brackets" href="#f6" id="id11">6</a>.</p></li>
<li><p>Creating a new database user with the given name and password on an Atlas Cluster <a class="footnote-reference brackets" href="#f7" id="id12">7</a>.</p></li>
<li><p>Modifying the Cluster Configuration Options of a given, already running Atlas Cluster <a class="footnote-reference brackets" href="#f3" id="id13">3</a>, <a class="footnote-reference brackets" href="#f4" id="id14">4</a>.</p></li>
<li><p>Retrieving the server logs from all hosts in an Atlas Cluster <a class="footnote-reference brackets" href="#f8" id="id15">8</a>.</p></li>
<li><p>Retrieving the Cluster State of a given Atlas Cluster.</p></li>
</ol>
<p>To prevent leaking MongoDB Atlas API credentials from the test machines, the Test Orchestrator MUST support
the specification of API credentials via environment variables.</p>
</div>
<div class="section" id="id16">
<h3><a class="toc-backref" href="#id31">User-Facing API</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
<p>The Test Orchestrator MUST be an executable that supports the following invocation pattern:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">test</span><span class="o">-</span><span class="n">orchestrator</span> <span class="n">spec</span><span class="o">-</span><span class="n">tests</span> <span class="n">run</span><span class="o">-</span><span class="n">one</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">workload</span><span class="o">-</span><span class="n">spec</span><span class="o">.</span><span class="n">yaml</span> <span class="o">-</span><span class="n">e</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">workload</span><span class="o">-</span><span class="n">executor</span>
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">test-orchestrator</span></code> is the Test Orchestrator executable,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">spec-tests</span> <span class="pre">run-one</span></code> is the name of the command issued to this executable,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">path/to/workload-spec.yaml</span></code> is the path to a test scenario file,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-e</span></code> is a flag indicating that the following argument is the workload executor binary, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">path/to/workload-executor</span></code> is the path to the workload executor binary that is to be used to run the Driver Workload.</p></li>
</ul>
</div>
<div class="section" id="id17">
<h3><a class="toc-backref" href="#id32">Pseudocode Implementation</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<p>The pseudocode implementation in this section is provided for illustrative purposes only. For the sake of simplicity,
all interaction with the Atlas API in this sample implementation is handled by the <code class="docutils literal notranslate"><span class="pre">AtlasController</span></code> class which
implements the following interface:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">interface</span> <span class="n">AtlasController</span> <span class="p">{</span>
    <span class="c1"># Creates a new Atlas cluster from the &quot;initial&quot; Cluster Configuration Options of the given maintenanceScenario.</span>
    <span class="c1"># Returns the cluster&#39;s connection string.</span>
    <span class="n">public</span> <span class="n">createNewCluster</span><span class="p">(</span><span class="n">maintenanceScenario</span><span class="p">:</span> <span class="nb">object</span><span class="p">):</span> <span class="n">string</span><span class="p">;</span>

    <span class="c1"># Initiates application of the &quot;final&quot; Cluster Configuration Options of the given maintenanceScenario.</span>
    <span class="n">public</span> <span class="n">triggerMaintenance</span><span class="p">(</span><span class="n">maintenanceScenario</span><span class="p">:</span> <span class="nb">object</span><span class="p">):</span> <span class="n">void</span><span class="p">;</span>

    <span class="c1"># Blocks until the Cluster State becomes IDLE. Implementations MUST poll the API to monitor the Cluster State.</span>
    <span class="c1"># Implementations MUST account for rate limits on Atlas API resources and retry requests that fail</span>
    <span class="c1"># with a &quot;429 Too Many Requests&quot; response code.</span>
    <span class="n">public</span> <span class="n">waitUntilClusterIdle</span><span class="p">():</span> <span class="n">void</span><span class="p">;</span>

    <span class="c1"># Fetches the server (mongod &amp; mongos) logs from the Atlas Cluster nodes and writes them to disk.</span>
    <span class="n">public</span> <span class="n">writeServerLogs</span><span class="p">():</span> <span class="n">void</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then, the Test Orchestrator can be implemented as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import the atlas controller.</span>
<span class="kn">import</span> <span class="p">{</span> <span class="n">AtlasAPI</span> <span class="p">}</span> <span class="kn">from</span> <span class="s2">&quot;atlasController&quot;</span>

<span class="c1"># The testOrchestrator function accepts the path to a scenario YAML file</span>
<span class="c1"># and the path to the workload executor executable. This function will be invoked with arguments</span>
<span class="c1"># parsed from the command-line invocation of the test orchestrator binary.</span>
<span class="n">function</span> <span class="n">testOrchestrator</span><span class="p">(</span><span class="n">scenarioFile</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="n">workloadExecutorPath</span><span class="p">:</span> <span class="n">string</span><span class="p">):</span> <span class="n">void</span> <span class="p">{</span>

    <span class="c1"># Initialize Atlas controller.</span>
    <span class="n">const</span> <span class="n">atlasController</span> <span class="o">=</span> <span class="n">AtlasController</span><span class="p">();</span>

    <span class="c1"># Parse the maintenance scenario and the driver workload from the file.</span>
    <span class="n">maintenanceScenario</span><span class="p">,</span> <span class="n">driverWorkload</span> <span class="o">=</span> <span class="n">parseScenario</span><span class="p">(</span><span class="n">scenarioFile</span><span class="p">);</span>

    <span class="c1"># Create a cluster and wait for it to be ready for running operations.</span>
    <span class="n">connectionString</span> <span class="o">=</span> <span class="n">atlasController</span><span class="o">.</span><span class="n">createNewCluster</span><span class="p">(</span><span class="n">maintenanceScenario</span><span class="p">);</span>
    <span class="n">atlasController</span><span class="o">.</span><span class="n">waitUntilClusterIdle</span><span class="p">();</span>

    <span class="c1"># Initiate the driver workload in a subprocess.</span>
    <span class="n">workloadSubprocess</span> <span class="o">=</span> <span class="n">spawnProcess</span><span class="p">([</span><span class="n">workloadExecutorPath</span><span class="p">,</span> <span class="n">connectionString</span><span class="p">,</span> <span class="n">driverWorkload</span><span class="p">]);</span>

    <span class="c1"># Implement maintenance plan and wait for completion.</span>
    <span class="n">atlasController</span><span class="o">.</span><span class="n">triggerMaintenance</span><span class="p">(</span><span class="n">maintenanceScenario</span><span class="p">);</span>
    <span class="n">atlasController</span><span class="o">.</span><span class="n">waitUntilClusterIdle</span><span class="p">();</span>

    <span class="c1"># Send a SIGINT to the workload executor to terminate workloads that run indefinitely.</span>
    <span class="n">workloadSubprocess</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">);</span>

    <span class="c1"># Write the contents of the workload executor&#39;s standard streams (stdout and stderr) to file for debugging use.</span>
    <span class="n">writeWorkloadExecutorLogs</span><span class="p">(</span><span class="n">workloadSubprocess</span><span class="p">)</span>

    <span class="c1"># Fetch Atlas logs and write them to disk.</span>
    <span class="n">atlasController</span><span class="o">.</span><span class="n">writeServerLogs</span><span class="p">();</span>

    <span class="c1"># The test orchestrator SHOULD output one test result file per scenario file in the standard</span>
    <span class="c1"># XUnit XML Format. This will enable the elegant test status console on Evergreen.</span>
    <span class="c1"># The XUnit output MAY use the workload statistics returned by the executor to make this output more informative.</span>
    <span class="n">writeJUnitEntry</span><span class="p">(</span><span class="n">workloadSubprocess</span><span class="p">);</span>

    <span class="c1"># The test orchestrator sets the same exit-code as the workload executor to indicate test success/failure.</span>
    <span class="n">process</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">workloadSubprocess</span><span class="o">.</span><span class="n">exitCode</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="reference-implementation">
<h2><a class="toc-backref" href="#id33">Reference Implementation</a><a class="headerlink" href="#reference-implementation" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">astrolabe</span></code> distribution serves as the reference implementation of the Test Orchestrator described by this
specification. Please see PyMongo’s integration for an example of a Workload Executor implementation.</p>
<p class="rubric">Footnotes</p>
<dl class="footnote brackets">
<dt class="label" id="f1"><span class="brackets">1</span><span class="fn-backref">(<a href="#id1">1</a>,<a href="#id2">2</a>,<a href="#id3">3</a>)</span></dt>
<dd><p>See <a class="reference external" href="https://docs.atlas.mongodb.com/organizations-projects/">https://docs.atlas.mongodb.com/organizations-projects/</a> for details about the Organizations and Projects hierarchy in MongoDB Atlas.</p>
</dd>
<dt class="label" id="f2"><span class="brackets">2</span><span class="fn-backref">(<a href="#id4">1</a>,<a href="#id8">2</a>,<a href="#id10">3</a>)</span></dt>
<dd><p>Create One Cluster endpoint: <a class="reference external" href="https://docs.atlas.mongodb.com/reference/api/clusters-create-one/">https://docs.atlas.mongodb.com/reference/api/clusters-create-one/</a></p>
</dd>
<dt class="label" id="f3"><span class="brackets">3</span><span class="fn-backref">(<a href="#id5">1</a>,<a href="#id9">2</a>,<a href="#id13">3</a>)</span></dt>
<dd><p>Modify One Cluster endpoint: <a class="reference external" href="https://docs.atlas.mongodb.com/reference/api/clusters-modify-one/">https://docs.atlas.mongodb.com/reference/api/clusters-modify-one/</a></p>
</dd>
<dt class="label" id="f4"><span class="brackets">4</span><span class="fn-backref">(<a href="#id6">1</a>,<a href="#id14">2</a>)</span></dt>
<dd><p>Modify Advanced Configuration Options for One Cluster endpoint: <a class="reference external" href="https://docs.atlas.mongodb.com/reference/api/clusters-modify-advanced-configuration-options/">https://docs.atlas.mongodb.com/reference/api/clusters-modify-advanced-configuration-options/</a></p>
</dd>
<dt class="label" id="f5"><span class="brackets"><a class="fn-backref" href="#id7">5</a></span></dt>
<dd><p>Get One Cluster endpoint: <a class="reference external" href="https://docs.atlas.mongodb.com/reference/api/clusters-get-one/">https://docs.atlas.mongodb.com/reference/api/clusters-get-one/</a></p>
</dd>
<dt class="label" id="f6"><span class="brackets"><a class="fn-backref" href="#id11">6</a></span></dt>
<dd><p>Add Entries to IP Whitelist endpoint: <a class="reference external" href="https://docs.atlas.mongodb.com/reference/api/whitelist-add-one/">https://docs.atlas.mongodb.com/reference/api/whitelist-add-one/</a></p>
</dd>
<dt class="label" id="f7"><span class="brackets"><a class="fn-backref" href="#id12">7</a></span></dt>
<dd><p>Create Database User endpoint: <a class="reference external" href="https://docs.atlas.mongodb.com/reference/api/database-users-create-a-user/">https://docs.atlas.mongodb.com/reference/api/database-users-create-a-user/</a></p>
</dd>
<dt class="label" id="f8"><span class="brackets"><a class="fn-backref" href="#id15">8</a></span></dt>
<dd><p>Logs endpoint: <a class="reference external" href="https://docs.atlas.mongodb.com/reference/api/logs/">https://docs.atlas.mongodb.com/reference/api/logs/</a></p>
</dd>
</dl>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">astrolabe</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="integration-guide.html">Integration Guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Technical Design: Testing Drivers Against Atlas Planned Maintenance</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#abstract">Abstract</a></li>
<li class="toctree-l2"><a class="reference internal" href="#definitions">Definitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#architecture-overview">Architecture Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#test-scenario-format">Test Scenario Format</a></li>
<li class="toctree-l2"><a class="reference internal" href="#workload-executor">Workload Executor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#test-orchestrator">Test Orchestrator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="integration-guide.html" title="previous chapter">Integration Guide</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, MongoDB, Inc..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/specification.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>